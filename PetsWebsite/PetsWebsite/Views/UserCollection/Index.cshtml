@model IEnumerable<PetsWebsite.Models.Product>
@using System.Security.Claims

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css"
    integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />

@*我的最愛頁面*@
<div class="mt-3" style="display:flex; justify-content: center;">
    <label style="font-size: 35px;">我的最愛</label>
</div>

    <div class="container">
        <div class="row">
            @*麵包屑*@
            <div class="col-4 md-3 offset-2">
                <nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='currentColor'/%3E%3C/svg%3E&#34;);"
                    aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="~/Home/Index">首頁</a></li>
                        <li class="breadcrumb-item"><a href="~/Shop/Index">購物專區</a></li>
                        <li class="breadcrumb-item active" aria-current="page">我的最愛</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>










    <div class="row">
        @{
            int index = 0;
        }
        @foreach (var item in Model)
        {
            @*modal的id++，單價去小數*@
            index++;
            int UnitPrice = Convert.ToInt32(item.UnitPrice);
            <div class="w-100 d-flex justify-content-center">
                <div class="card mb-3 col col-12 cardlight" style="max-width: 800px;">
                    <div class="row row-cols-3 g-0 align-items-center justify-content-evenly position-relative"
                    style="max-width: 800px; height: 250px">
                        <img src="~/images/Product/@item.PhotoPath" style="width:25%" alt="目前無圖片，請稍後再試" />
                        <div class="col">
                            <div class="card-body">
                                <h4 class="card-title text-nowrap mt-0"> @item.ProductName</h4>
                                <label class="card-text mt-4 text-nowrap" style="font-size: 20px">單價:$&nbsp;@UnitPrice</label>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card-body mt-5">
                                <div class="d-grid gap-2 mt-1">
                                    <button class="btn btn-outline-warning btn-sm" value=@item.ProductId
                                    onclick="AddShopCar(event)" ><i class="fa-solid fa-cart-plus"></i>
                                        &nbsp放入購物車</button>
                                </div>
                                <div class="d-grid gap-2 mt-1">
                                    <button class="btn btn-outline-danger btn-sm" value=@item.ProductId
                                    onclick="AddShopCar(event)"><i class="fa-solid fa-heart-crack"></i>
                                        &nbsp取消收藏</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        }
    </div>

    @section Scripts{
    <script>
        function AddShopCar(e) {
            fetch("/api/ShoppingCar/AddShopCar/" + e.target.value)
                .then(res => res.json())
                .then(result => {
                    if (result) {
                        ShopCar.reLoadData();
                        swal({
                            title: '已加入購物車',
                            type: 'success',
                            closeOnClickOutside: false,
                            icon: "success",
                            timer: 1000,
                            button: false,
                        });
                    }
                })
        }
        function CheckoutShopCar(e) {
            fetch("/api/ShoppingCar/AddShopCar/" + e.target.value)
                .then(res => res.json())
                .then(result => {
                    if (result) {
                        ShopCar.reLoadData();
                        window.location.href = `/ShoppingCart/Index`;
                    }
                })
        }
        $("input[type=checkbox]").on("click", function (e) {
            var index = e.target.value;
            console.log(index)
            var Iscollect = $(this).prop("checked");
            if (Iscollect) {
                $.ajax({
                    type: "get",
                    url: `/api/UserCollect/AddCollect/${index}`
                }).done(function (res) {
                    console.log(res);
                }).fail(function (err) {
                    console.log(err);
                });
            } else {
                $.ajax({
                    type: "delete",
                    url: `/api/UserCollect/DeleteCollect/${index}`
                }).done(function (res) {
                    console.log(res);
                }).fail(function (err) {
                    console.log(err);
                    console.log(err);
                });
            }
        })
        function ConfirmCollect() {
            $.ajax({
                type: "get",
                url: `/api/UserCollect/GetUserCollectId`
            }).done(function (res) {
                var UserHaveCollect = $("input[type=checkbox]");
                for (let i = 0; i < UserHaveCollect.length; i++) {
                    if (res.includes(parseInt(UserHaveCollect[i].value))) {
                        UserHaveCollect[i].setAttribute("checked", "");
                    }
                }
            }).fail(function (err) {
                console.log(err);
            });
        };
        if ("@User.Claims.FirstOrDefault(X => X.Type == ClaimTypes.Role)?.Value" == "Member") {
            ConfirmCollect();
        }     
    </script>
    }
